<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light">
    <title>Checklist Pague Menos</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #004a99;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f4f7f9;
            --accent: #f9b233;
        }

        /* Bloqueio de sele√ß√£o, zoom e rolagem horizontal */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            touch-action: pan-y;
        }

        /* --- ANIMA√á√ÉO DE TRANSI√á√ÉO DE TELA --- */
        #transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            pointer-events: none;
            z-index: 10000;
        }

        .transition-bar {
            flex: 1;
            width: 100%;
            background: var(--primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s ease-in-out;
        }

        .transition-bar:nth-child(even) {
            transform-origin: right;
            background: #003a7a;
        }

        body.page-exit .transition-bar {
            transform: scaleX(1);
        }

        /* --- MODO ESCURO DO CHECKLIST --- */
        body.dark-mode {
            --bg: #121212;
            --primary: #0a192f;
            color: #e0e0e0;
        }

        body.dark-mode .card,
        body.dark-mode input,
        body.dark-mode #results {
            background: #1e1e1e !important;
            color: #fff !important;
            border-color: #333 !important;
        }

        body.dark-mode .section-title {
            background: #2a2a2a;
            color: var(--accent);
        }

        body.dark-mode .modal-content {
            background: #1e1e1e;
            color: #fff;
        }

        body.dark-mode .modal-question-box {
            background: #2a2a2a;
            color: #ccc;
            border-left-color: var(--accent);
        }

        body.dark-mode .btn-voltar {
            background: #1e1e1e;
            color: #fff;
            border: 1px solid #333;
        }

        /* Badge de Pontos para Modo Escuro */
        body.dark-mode .badge-pontos {
            background: rgba(249, 178, 51, 0.2);
            color: var(--accent);
        }

        /* Permite sele√ß√£o apenas nos inputs */
        input,
        textarea {
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            overscroll-behavior: none;

        }

        h1 {
            font-size: clamp(24px, 8vw, 32px) !important;
            margin: 0;
            font-weight: 800;
            letter-spacing: 2px;
        }

        /* Bot√£o Voltar */
        .btn-voltar {
            position: fixed;
            top: 15px;
            right: 15px;

            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 14px;

            padding: 10px 16px;
            min-height: 35px;

            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.6px;
            text-transform: uppercase;

            display: flex;
            align-items: center;
            gap: 8px;

            cursor: pointer;
            z-index: 2000;
        }

        /* Efeito visual ao tocar/clicar */
        .btn-voltar:active {
            transform: scale(0.95);
            background: #f0f4f8;
        }

        /* Ajuste opcional para √≠cone */
        .btn-voltar i {
            font-size: 16px;
        }


        .logo-fixa {
            position: absolute;
            top: 15px;
            left: 15px;
            width: clamp(45px, 12vw, 60px);
            height: auto;
            object-fit: cover;
            z-index: 1000;
        }

        .container {
            width: 100%;
            max-width: 550px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            position: relative;
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 50px 20px 30px 20px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            overflow: hidden;
        }

        .header-text p {
            margin: 3px 0 0;
            opacity: 0.8;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e6ed;
            overflow: hidden;
            width: 92%;
        }

        label {
            font-weight: bold;
            font-size: 11px;
            color: #888;
            display: block;
            margin-top: 10px;
            text-transform: uppercase;
        }

        input {
            width: 100%;
            padding: 14px;
            margin: 6px 0;
            border: 1px solid #ccd6e0;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            background: #fff;
            color: #333;
        }

        .section-title {
            font-weight: bold;
            color: var(--primary);
            background: #f0f4f8;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-transform: uppercase;
            text-align: center;
            font-size: 13px;
        }

        .item {
            padding: 18px 10px;
            border-bottom: 1px solid #f1f1f1;
            transition: all 0.5s ease;
            background-repeat: no-repeat;
            background-size: 0% 100%;
        }

        .item.respondido {
            opacity: 0.6;
        }

        .item.resp-sim {
            background-image: linear-gradient(to right, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.1));
            background-size: 100% 100%;
        }

        .item.resp-nao {
            background-image: linear-gradient(to left, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.1));
            background-size: 100% 100%;
        }

        /* Estilo da Etiqueta de Pontua√ß√£o */
        .badge-pontos {
            display: inline-block;
            font-size: 10px;
            background: var(--accent);
            color: #6a4600;
            padding: 3px 6px;
            border-radius: 6px;
            margin-left: 6px;
            font-weight: 800;
            vertical-align: middle;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .btn {
            padding: 16px;
            border: 1px solid #ccd6e0;
            border-radius: 10px;
            background: #fff;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            color: #333;
        }

        .btn.active-yes {
            background: var(--success) !important;
            color: white;
            border-color: var(--success);
        }

        .btn.active-no {
            background: var(--danger) !important;
            color: white;
            border-color: var(--danger);
        }

        .btn-fin {
            width: 92%;
            padding: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 18px;
            margin: 10px 0;
            cursor: pointer;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .modal-question-box {
            background: #f8f9fa;
            border-left: 5px solid var(--primary);
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: left;
            font-style: italic;
            color: #444;
            font-size: 14px;
            line-height: 1.4;
        }

        #results {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 92%;
            border: 2px solid var(--primary);
            margin-bottom: 30px;
        }

        pre {
            background: #fdfdfd;
            padding: 15px;
            white-space: pre-wrap;
            font-size: 13px;
            border: 1px solid #eee;
            color: #2c3e50;
            border-radius: 8px;
            font-family: monospace;
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        #toast {
            position: fixed;
            top: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            display: none;
            z-index: 10000;
            font-weight: bold;
        }

        .footer-logo {
            margin-top: auto;
            padding: 20px 0;
            text-align: center;
            width: 100%;
        }

        .footer-logo img {
            width: clamp(90px, 25vw, 110px);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        footer {
            font-size: clamp(10px, 3vw, 11px);
            color: #999;
            text-align: center;
            padding: 0 20px 40px;
        }

        .extra-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        .btn-small {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            color: #555;
        }

        #checklist-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #results,
            #results * {
                visibility: visible;
            }

            #results {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                border: none;
            }

            .btn-fin,
            .extra-options,
            .btn-voltar {
                display: none !important;
            }
        }

        /* Card de Vers√£o no Rodap√© */
        .version-card {
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: rgba(0, 74, 153, 0.05);
            border: 1px solid rgba(0, 74, 153, 0.1);
            border-radius: 100px;
            transition: all 0.3s ease;
        }

        .version-label {
            font-size: 9px;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        #app-version-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 11px;
            font-weight: bold;
            color: var(--accent);
        }


        /* --- TELA DE CARREGAMENTO (ESTILO UNIFICADO) --- */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100dvh;
            background: #004a99;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        .logo-container img {
            width: 90px;
            height: 90px;
            border-radius: 22px;
            object-fit: cover;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            animation: logoFloat 2.5s ease-in-out infinite;
        }

        .loading-text {
            color: white;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 3px;
            margin: 0;
            opacity: 0.8;
        }

        .loading-bar-container {
            width: 160px;
            height: 5px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .loading-bar-fill {
            width: 45%;
            height: 100%;
            background: #f9b233;
            border-radius: 10px;
            animation: progressMove 1.5s infinite ease-in-out;
        }

        .loader-hidden {
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        @keyframes logoFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes progressMove {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(250%);
            }
        }
    </style>
</head>

<body>

    <div id="loading-screen">
        <div class="loader-content">
            <div class="logo-container">
                <img src="icone_novo.png" alt="Logo">
            </div>
            <p class="loading-text">CARREGANDO SISTEMA</p>
            <div class="loading-bar-container">
                <div class="loading-bar-fill"></div>
            </div>
        </div>
    </div>


    <div id="transition-overlay">
        <div class="transition-bar"></div>
        <div class="transition-bar"></div>
        <div class="transition-bar"></div>
        <div class="transition-bar"></div>
    </div>

    <button class="btn-voltar" onclick="voltarInicio()">
        <i class="fas fa-arrow-left"></i> VOLTAR
    </button>

    <img src="icone_novo.png" alt="√çcone" class="logo-fixa">

    <div id="toast"></div>

    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: var(--primary); margin-top: 0;">Alterar Resposta?</h3>
            <p style="margin-bottom: 5px;">Voc√™ deseja mudar para <strong id="modal-new-choice"></strong> a pergunta:
            </p>
            <div id="modal-question-text" class="modal-question-box"></div>
            <div class="modal-btns" style="display: flex; gap: 10px;">
                <button class="btn" style="flex:1" onclick="fecharModalConfirm(false)">CANCELAR</button>
                <button class="btn" style="flex:1; background: var(--primary); color: white;"
                    onclick="fecharModalConfirm(true)">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="modal-alert" class="modal-overlay">
        <div class="modal-content">
            <h3 id="alert-title" style="color: var(--danger);">‚ö†Ô∏è Aten√ß√£o</h3>
            <p id="alert-msg"></p>
            <button class="btn-fin" style="margin: 10px 0 0; padding: 15px; width: 100%;"
                onclick="fecharAlerta()">ENTENDI</button>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="header-text">
                <h1>CHECK-LIST</h1>
                <p>CLIENTE OCULTO</p>
            </div>
        </header>

        <div class="card">
            <label>Colaborador Avaliado</label>
            <input type="text" id="nome" placeholder="Nome completo">
            <label>Matr√≠cula</label>
            <input type="tel" id="matri" placeholder="Ex: 000000" inputmode="numeric">
        </div>

        <div id="checklist-area"></div>

        <button id="btn-gerar-relatorio" class="btn-fin" onclick="finalizar()">GERAR RELAT√ìRIO FINAL</button>
        <div id="results">
            <h3 id="score" style="text-align:center; color: var(--primary); margin: 0 0 15px 0;"></h3>
            <pre id="relatorio"></pre>

            <button class="btn-fin" style="background:#25D366; margin-bottom: 5px; width: 100%;" onclick="copiar()">
                <i class="fab fa-whatsapp"></i> COPIAR PARA WHATSAPP
            </button>

            <div class="extra-options">
                <button class="btn-small" onclick="gerarPDF()"><i class="fas fa-file-pdf"></i> SALVAR PDF</button>
                <button class="btn-small" onclick="gerarExcel()"><i class="fas fa-file-excel"></i> GERAR EXCEL</button>
            </div>
        </div>

        <div class="footer-logo">
            <img src="PagueMenosLogo.png" alt="Pague Menos">
            <footer>
                Desenvolvido por <strong>Erik Henrique - 126841</strong><br>
                <strong>Sistema n√£o oficial</strong>, voltado ao apoio e acompanhamento do atendimento em rela√ß√£o ao
                cliente oculto.
                <br>
                <div class="version-card">
                    <span class="version-label">Vers√£o</span>
                    <span id="app-version-display">Carregando...</span>
                </div>
            </footer>
        </div>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

        <script>

            // 1. L√™ a mem√≥ria instantaneamente ao abrir a tela (FECHA O BLOCO AQUI!)
            if (localStorage.getItem('dark-mode') === 'true') {
                document.body.classList.add('dark-mode');
            }

            // 2. Limpa a anima√ß√£o de sa√≠da caso o usu√°rio retorne pelo bot√£o de voltar do celular (bfcache)
            window.addEventListener('pageshow', function (event) {
                if (document.body.classList.contains('page-exit')) {
                    document.body.classList.remove('page-exit');
                }
            });

            // 3. Empurra um estado falso no hist√≥rico para evitar sa√≠da acidental
            history.pushState(null, null, location.href);
            window.addEventListener("popstate", function () {
                history.pushState(null, null, location.href);
            });

            // 4. Fun√ß√£o para voltar ao index com anima√ß√£o
            function voltarInicio() {
                document.body.classList.add('page-exit');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 450);
            }

            // Bloqueio de zoom
            document.addEventListener('wheel', function (e) {
                if (e.ctrlKey) e.preventDefault();
            }, { passive: false });

            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey && (e.keyCode === 61 || e.keyCode === 107 || e.keyCode === 173 || e.keyCode === 109 || e.keyCode === 187 || e.keyCode === 189)) {
                    e.preventDefault();
                }
            });

            // --- DADOS DO CHECKLIST (AGORA COM PONTOS) ---
            // Altere o valor de "pontos" para a nota real de cada pergunta. Use 0 para perguntas que n√£o pontuam.
            const perguntas = {
                "SAL√ÉO": [
                    { texto: "Abordou cliente no sal√£o?", pontos: 3 },
                    { texto: "O colaborador interrompeu as atividades administrativas para priorizar o atendimento ao cliente?", pontos: 3 },
                    { texto: "Colaborador se apresentou pelo nome?", pontos: 3 },
                    { texto: "O colaborador foi atencioso, emp√°tico e cordial?", pontos: 3 },
                    { texto: "Buscou entender a necessidade do cliente?", pontos: 2 },
                    { texto: "Acompanhou o cliente at√© a se√ß√£o?", pontos: 2 }
                ],
                "BALC√ÉO": [
                    { texto: "O colaborador se apresentou pelo nome?", pontos: 2 },
                    { texto: "Solicitou o cadastro?", pontos: 3 },
                    { texto: "Atualizou cadastro?", pontos: 1 },
                    { texto: "Chamou o cliente pelo nome?", pontos: 3 },
                    { texto: "Destacou descontos e vantagens, como promo√ß√µes e/ou parcerias?", pontos: 3 },
                    { texto: "Entregou cupom DSM explicando o que se tratava?", pontos: 2 },
                    { texto: "Informou sobre programa de fidelidade?", pontos: 2 },
                    { texto: "Informou Medalha do cliente?", pontos: 1 },
                    { texto: "Ofertou Clinicfarma?", pontos: 0 },
                    { texto: "Soube responder questionamento sobre medicamento/produto?", pontos: 2 },
                    { texto: "Colaborador foi atencioso, emp√°tico e cordial?", pontos: 3 }
                ],
                "CAIXA": [
                    { texto: "Solicitou CPF ou bipou cupom impresso no balc√£o?", pontos: 3 },
                    { texto: "Solicitou a avalia√ß√£o do Atend√¥metro?", pontos: 1 },
                    { texto: "Destacou desconto da compra?", pontos: 3 },
                    { texto: "Perguntou as formas de pagamento? (PIX, DINHEIRO OU D√âBITO)", pontos: 1 },
                    { texto: "Ofereceu Super Troco? (DOA√á√ÉO)", pontos: 0 },
                    { texto: "Ofertou envio do cupom por e-mail?", pontos: 1 },
                    { texto: "Pagamento ocorreu sem trava/lentid√£o?", pontos: 1 },
                    { texto: "Finalizou com CONTE SEMPRE COM A PAGUE MENOS ?", pontos: 3 },
                    { texto: "O colaborador foi atencioso, emp√°tico e cordial?", pontos: 3 },
                    { texto: "Acompanhou o cliente at√© a sa√≠da ou saiu da √°rea do caixa para entregar as compras?", pontos: 1 }
                ],
                "PERGUNTAS EXTRAS": [
                    { texto: "Sauda√ß√£o Seja bem-vindo √† Pague Menos", pontos: 0 },
                    { texto: "Ofertou produto Foco?", pontos: 0 },
                    { texto: "Ofertou aumento UVC (Cliente cr√¥nico)", pontos: 0 },
                    { texto: "Ofertou produtos do Super Descontos?", pontos: 0 },
                    { texto: "Organizou a fila de atendimento?", pontos: 0 }
                ]
            };

            let respostas = {};
            let horaInicio = "";
            let itemPendente = { id: null, valor: null };
            let relatorioObj = null;
            let elementoFocoPendente = null; // Guarda onde a tela deve rolar
            let totalPerguntasGeral = 0;     // Guarda o total de perguntas

            function montar() {
                const agora = new Date();
                horaInicio = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const area = document.getElementById('checklist-area');
                let html = '';
                totalPerguntasGeral = 0;

                for (let secao in perguntas) {
                    html += `<div class="card"><div class="section-title">${secao}</div>`;
                    perguntas[secao].forEach((p, i) => {
                        totalPerguntasGeral++;
                        const id = secao + "-" + i;

                        // Etiqueta de pontos
                        const badgeHTML = p.pontos > 0 ? `<span class="badge-pontos">${p.pontos} pts</span>` : ``;

                        html += `<div class="item" id="item-${id}">
                        <div id="text-${id}" style="font-size:15px; margin-bottom:12px; font-weight:500;">
                            ${p.texto} ${badgeHTML}
                        </div>
                        <div class="btns">
                            <button class="btn" id="y-${id}" onclick="tentarMarcar('${id}', 1)">SIM ‚úÖ</button>
                            <button class="btn" id="n-${id}" onclick="tentarMarcar('${id}', 0)">N√ÉO ‚ùå</button>
                        </div>
                    </div>`;
                    });
                    html += `</div>`;
                }
                area.innerHTML = html;
            }

            function tentarMarcar(id, valor) {
                if (respostas[id] === valor) return;
                if (respostas[id] !== undefined) {
                    itemPendente = { id, valor };
                    document.getElementById('modal-new-choice').innerText = valor === 1 ? "SIM ‚úÖ" : "N√ÉO ‚ùå";
                    // Extrai o texto limpo sem o HTML do badge
                    let textoLimpo = document.getElementById('text-' + id).innerText;
                    document.getElementById('modal-question-text').innerText = textoLimpo;
                    document.getElementById('modal-confirm').style.display = 'flex';
                } else {
                    executarMarcacao(id, valor);
                }
            }

            function fecharModalConfirm(confirmado) {
                if (confirmado) executarMarcacao(itemPendente.id, itemPendente.valor);
                document.getElementById('modal-confirm').style.display = 'none';
            }

            function executarMarcacao(id, valor) {
                respostas[id] = valor;
                const itemDiv = document.getElementById("item-" + id);
                document.getElementById("y-" + id).className = "btn";
                document.getElementById("n-" + id).className = "btn";
                itemDiv.classList.remove("resp-sim", "resp-nao", "respondido");
                void itemDiv.offsetWidth;
                itemDiv.classList.add("respondido");
                if (valor === 1) {
                    document.getElementById("y-" + id).classList.add("active-yes");
                    itemDiv.classList.add("resp-sim");
                } else {
                    document.getElementById("n-" + id).classList.add("active-no");
                    itemDiv.classList.add("resp-nao");
                }

                // Se respondeu a √∫ltima pergunta, rola para o bot√£o de finalizar
                if (Object.keys(respostas).length === totalPerguntasGeral) {
                    setTimeout(() => {
                        document.getElementById('btn-gerar-relatorio').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 400);
                }
            }

            function showAlert(msg) {
                document.getElementById('alert-msg').innerText = msg;
                document.getElementById('modal-alert').style.display = 'flex';
            }

            function fecharAlerta() {
                document.getElementById('modal-alert').style.display = 'none';

                // Se houver algo pendente gravado, rola at√© ele
                if (elementoFocoPendente) {
                    setTimeout(() => {
                        elementoFocoPendente.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Se for campo de texto (Nome/Matr√≠cula), j√° abre o teclado
                        if (elementoFocoPendente.tagName === 'INPUT') {
                            elementoFocoPendente.focus();
                        }
                        elementoFocoPendente = null;
                    }, 300);
                }
            }

            function finalizar() {
                const inputNome = document.getElementById('nome');
                const inputMatri = document.getElementById('matri');
                const nome = inputNome.value.trim();
                const matri = inputMatri.value.trim();
                const respondidas = Object.keys(respostas).length;

                if (!nome) {
                    elementoFocoPendente = inputNome;
                    return showAlert("Informe o nome do colaborador.");
                }

                if (!matri) {
                    elementoFocoPendente = inputMatri;
                    return showAlert("Informe a matr√≠cula.");
                }

                if (respondidas < totalPerguntasGeral) {
                    for (let secao in perguntas) {
                        for (let i = 0; i < perguntas[secao].length; i++) {
                            const id = secao + "-" + i;
                            if (respostas[id] === undefined) {
                                elementoFocoPendente = document.getElementById('item-' + id);
                                return showAlert(`Responda as ${totalPerguntasGeral - respondidas} perguntas restantes.`);
                            }
                        }
                    }
                }

                const agora = new Date();
                let acertosDeSim = 0;

                // ==========================================
                // ‚öôÔ∏è CONFIGURA√á√ÉO DOS PONTOS OCULTOS
                // ==========================================
                // Defina aqui a pontua√ß√£o das perguntas que N√ÉO est√£o no checklist
                let pontosOcultosPossiveis = 45; // Quantos pontos as perguntas ocultas valem no total
                let pontosOcultosObtidos = 45;   // Quantos pontos o colaborador ganha automaticamente nelas

                // Iniciamos a contagem j√° com os pontos ocultos
                let pontosObtidos = pontosOcultosObtidos;
                let totalPontosPossiveis = pontosOcultosPossiveis;
                // ==========================================

                let rel = "*AVALIA√á√ÉO CLIENTE OCULTO - PAGUE MENOS*\n--------------------------------\n";
                rel += `üë§ *Colaborador:* ${nome}\nüÜî *Matr√≠cula:* ${matri}\nüìÖ *Data:* ${agora.toLocaleDateString('pt-BR')}\n‚è∞ *In√≠cio:* ${horaInicio} | *Fim:* ${agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\n--------------------------------\n`;

                for (let secao in perguntas) {
                    rel += `\nüîπ *${secao}*`;
                    perguntas[secao].forEach((p, i) => {
                        const r = respostas[secao + "-" + i] === 1;
                        totalPontosPossiveis += p.pontos;

                        if (r) {
                            acertosDeSim++;
                            pontosObtidos += p.pontos;
                        }

                        // Formata o texto para WhatsApp mostrando os pontos
                        let txtPontos = p.pontos > 0 ? ` (${p.pontos} pts)` : "";
                        rel += `\n${r ? "‚úÖ" : "‚ùå"} ${p.texto}${txtPontos}`;
                    });
                    rel += "\n";
                }

                // Garante que os pontos obtidos nunca ultrapassem o total poss√≠vel
                pontosObtidos = Math.min(pontosObtidos, totalPontosPossiveis);

                // C√°lculos Finais
                const porcentagemSim = ((acertosDeSim / totalPerguntasGeral) * 100).toFixed(0);
                let notaCalculada = totalPontosPossiveis > 0 ? ((pontosObtidos / totalPontosPossiveis) * 100) : 0;

                // Trava a nota m√°xima em 100%
                const notaClienteOculto = Math.min(notaCalculada, 100).toFixed(0);
                rel += `\n--------------------------------\nüèÜ *NOTA CLIENTE OCULTO: ${notaClienteOculto}%* (${pontosObtidos}/${totalPontosPossiveis} pts)\nüìä *TAXA DE ACERTOS (SIM): ${porcentagemSim}%*\n--------------------------------\n_Gerado Por Erik Henrique - 126841_`;

                document.getElementById('relatorio').innerText = rel;
                document.getElementById('score').innerText = `NOTA: ${notaClienteOculto}% | ACERTOS: ${porcentagemSim}%`;
                document.getElementById('results').style.display = 'block';
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

                // ===== OBJETO BASE DO RELAT√ìRIO (PDF / EXCEL) =====
                relatorioObj = {
                    colaborador: nome,
                    matricula: matri,
                    data: agora.toLocaleDateString('pt-BR'),
                    inicio: horaInicio,
                    fim: agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                    nota: notaClienteOculto,
                    porcentagemSim: porcentagemSim,
                    secoes: []
                };

                for (let secao in perguntas) {
                    const itens = perguntas[secao].map((p, i) => ({
                        // Passa os pontos para o PDF tamb√©m
                        pergunta: p.pontos > 0 ? `${p.texto} (${p.pontos} pts)` : p.texto,
                        resposta: respostas[secao + "-" + i] === 1 ? "SIM" : "N√ÉO"
                    }));
                    relatorioObj.secoes.push({ nome: secao, itens });
                }
                // ... c√≥digo anterior onde define o relatorioObj ...

// --- SALVAMENTO NO HIST√ìRICO PERSISTENTE ---
let historicoLocal = JSON.parse(localStorage.getItem('checklist_history')) || [];
historicoLocal.unshift(relatorioObj); // Adiciona a nova avalia√ß√£o no topo da lista
localStorage.setItem('checklist_history', JSON.stringify(historicoLocal));

showToast("Avalia√ß√£o salva no hist√≥rico!");
// ... resto da fun√ß√£o finalizar ...
            }
            
            
            function copiar() {
                navigator.clipboard.writeText(document.getElementById('relatorio').innerText);
                const toast = document.getElementById('toast');
                toast.innerText = "üìã Relat√≥rio copiado!";
                toast.style.display = "block";
                setTimeout(() => toast.style.display = "none", 2000);
            }

            function gerarPDF() {
                if (!relatorioObj) {
                    alert("Gere o relat√≥rio antes de salvar o PDF.");
                    return;
                }

                const logo = new Image();
                logo.src = "PagueMenosLogo.png";

                logo.onload = function () {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF("p", "mm", "a4");

                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();

                    const marginX = 10;
                    const topMargin = 10;
                    const bottomMargin = 10;

                    const usableWidth = pageWidth - marginX * 2;
                    const usableHeight = pageHeight - topMargin - bottomMargin;

                    let baseFont = 8.5;
                    let lineHeight = 3.6;

                    function calcularAltura(fontSize) {
                        doc.setFontSize(fontSize);
                        let h = 0;

                        h += 12; // cabe√ßalho
                        h += 16; // identifica√ß√£o
                        h += 9;  // nota

                        relatorioObj.secoes.forEach(secao => {
                            h += 7;
                            secao.itens.forEach(item => {
                                const linhas = doc.splitTextToSize(item.pergunta, usableWidth - 24);
                                h += linhas.length * (fontSize * 0.42) + 2;
                            });
                            h += 3;
                        });

                        return h;
                    }

                    while (calcularAltura(baseFont) > usableHeight && baseFont > 6.5) {
                        baseFont -= 0.3;
                    }

                    doc.setFontSize(baseFont);
                    lineHeight = baseFont * 0.42;

                    let y = topMargin;

                    /* ================= CABE√áALHO ================= */
                    doc.setFillColor(0, 74, 153);
                    doc.rect(marginX, y, usableWidth, 10, "F");

                    doc.setTextColor(255);
                    doc.setFontSize(baseFont + 4);
                    doc.setFont(undefined, "bold");
                    doc.text("RELAT√ìRIO DE AVALIA√á√ÉO - CLIENTE OCULTO", pageWidth / 2, y + 7, { align: "center" });

                    y += 13;
                    doc.setTextColor(0);
                    doc.setFontSize(baseFont);
                    doc.setFont(undefined, "normal");

                    /* ================= IDENTIFICA√á√ÉO COM LOGO ================= */
                    const boxHeight = 16;
                    doc.rect(marginX, y, usableWidth, boxHeight);

                    doc.setFont(undefined, "bold");
                    doc.text(`Colaborador: ${relatorioObj.colaborador}`, marginX + 2, y + 6);
                    doc.text(`Matr√≠cula: ${relatorioObj.matricula}`, marginX + 2, y + 11);

                    doc.setFont(undefined, "normal");
                    doc.text(`Data: ${relatorioObj.data}`, marginX + 80, y + 6);
                    doc.text(`Hor√°rio: ${relatorioObj.inicio} √†s ${relatorioObj.fim}`, marginX + 80, y + 11);

                    const logoWidth = 24;
                    const logoHeight = 10;
                    const logoX = marginX + usableWidth - logoWidth - 3;
                    const logoY = y + (boxHeight - logoHeight) / 2;

                    doc.addImage(logo, "PNG", logoX, logoY, logoWidth, logoHeight);

                    y += boxHeight + 4;

                    /* ================= NOTA FINAL ================= */
                    doc.setFillColor(240, 244, 248);
                    doc.rect(marginX, y, usableWidth, 9, "F");
                    doc.rect(marginX, y, usableWidth, 9);

                    doc.setFontSize(baseFont + 1);
                    doc.setFont(undefined, "bold");
                    doc.text(
                        `NOTA CLIENTE OCULTO(em desenvolvimento!): ${relatorioObj.nota}%  |  TAXA DE ACERTOS: ${relatorioObj.porcentagemSim}%`,
                        pageWidth / 2,
                        y + 6,
                        { align: "center" }
                    );

                    y += 12;
                    doc.setFontSize(baseFont);
                    doc.setFont(undefined, "normal");

                    /* ================= SE√á√ïES ================= */
                    relatorioObj.secoes.forEach(secao => {
                        doc.setFillColor(230, 236, 242);
                        doc.rect(marginX, y, usableWidth, 6, "F");
                        doc.rect(marginX, y, usableWidth, 6);

                        doc.setFont(undefined, "bold");
                        doc.setTextColor(0);
                        doc.text(secao.nome, marginX + 2, y + 4.5);

                        y += 8;
                        doc.setFont(undefined, "normal");

                        secao.itens.forEach(item => {
                            const linhas = doc.splitTextToSize(item.pergunta, usableWidth - 24);
                            const altura = linhas.length * lineHeight + 2;
                            const isNao = item.resposta === "N√ÉO";

                            if (isNao) {
                                doc.setFillColor(40, 40, 40);
                                doc.setDrawColor(255, 255, 255);
                                doc.rect(marginX, y, usableWidth, altura, "FD");
                                doc.setTextColor(255);
                            } else {
                                doc.setDrawColor(0);
                                doc.setFillColor(255, 255, 255);
                                doc.rect(marginX, y, usableWidth, altura);
                                doc.setTextColor(0);
                            }

                            doc.text(linhas, marginX + 2, y + lineHeight);
                            doc.setFont(undefined, "bold");
                            doc.text(item.resposta, pageWidth - marginX - 2, y + lineHeight, { align: "right" });
                            doc.setFont(undefined, "normal");

                            y += altura;
                        });

                        y += 3;
                    });

                    /* ================= RODAP√â ================= */
                    doc.setFontSize(7);
                    doc.setTextColor(0);
                    doc.text("Sistema n√£o oficial ‚Ä¢ Gerado por Erik Henrique - 126841", pageWidth / 2, pageHeight - 6, { align: "center" });

                    doc.save(`Checklist_${relatorioObj.colaborador}.pdf`);
                };
            }

            function gerarExcel() {
                const nome = document.getElementById('nome').value || "relatorio";
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Pergunta;Resposta\r\n";

                for (let secao in perguntas) {
                    csvContent += `--- ${secao} ---;\r\n`;
                    perguntas[secao].forEach((p, i) => {
                        const r = respostas[secao + "-" + i] === 1 ? "SIM" : "NAO";
                        // Mostra os pontos no Excel tamb√©m
                        const perguntaFormatada = p.pontos > 0 ? `${p.texto} (${p.pontos} pts)` : p.texto;
                        csvContent += `${perguntaFormatada};${r}\r\n`;
                    });
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Checklist_${nome}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            async function displayVersion() {
                try {
                    const response = await fetch(`version.json?v=${Date.now()}`);
                    if (response.ok) {
                        const data = await response.json();
                        const displayElement = document.getElementById('app-version-display');
                        if (displayElement) {
                            displayElement.innerText = data.version;
                        }
                    }
                } catch (err) {
                    const displayElement = document.getElementById('app-version-display');
                    if (displayElement) displayElement.innerText = "---";
                    console.warn("N√£o foi poss√≠vel carregar a vers√£o no rodap√©.");
                }
            }

            /* --- L√ìGICA DE CARREGAMENTO ROBUSTA --- */
            function fecharLoader() {
                const loader = document.getElementById('loading-screen');
                if (loader) {
                    loader.classList.add('loader-hidden');
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 600);
                }
            }

            async function inicializarAppCompleto() {
                // 1. Aguarda os recursos est√°ticos (HTML, CSS e as bibliotecas jsPDF/Excel)
                const aguardarEstatico = new Promise(resolve => {
                    if (document.readyState === 'complete') {
                        resolve();
                    } else {
                        window.addEventListener('load', resolve);
                    }
                });

                // 2. Requisi√ß√£o din√¢mica do servidor
                const aguardarVersao = displayVersion();

                try {
                    await aguardarEstatico;
                    montar(); // Cria o formul√°rio na tela
                    await aguardarVersao;
                } catch (erro) {
                    console.error("Erro durante o carregamento da tela de checklist:", erro);
                } finally {
                    // Remove o tela azul apenas quando tudo estiver pronto
                    fecharLoader();
                }
            }

            // Inicia o processo
            inicializarAppCompleto();

        </script>
</body>

</html>